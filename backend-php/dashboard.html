<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StudyMate API - Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --bg-card: #ffffff;
            --text-primary: #212529;
            --text-secondary: #6c757d;
            --border-color: #dee2e6;
            --success: #28a745;
            --danger: #dc3545;
            --warning: #ffc107;
            --info: #17a2b8;
            --primary: #007bff;
            --code-bg: #f5f5f5;
        }

        [data-theme="dark"] {
            --bg-primary: #1a1a1a;
            --bg-secondary: #2d2d2d;
            --bg-card: #2d2d2d;
            --text-primary: #e9ecef;
            --text-secondary: #adb5bd;
            --border-color: #495057;
            --success: #28a745;
            --danger: #dc3545;
            --warning: #ffc107;
            --info: #17a2b8;
            --primary: #007bff;
            --code-bg: #1e1e1e;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            transition: background-color 0.3s, color 0.3s;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: var(--bg-card);
            border-bottom: 2px solid var(--border-color);
            padding: 20px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        h1 {
            font-size: 2rem;
            color: var(--primary);
        }

        h2 {
            font-size: 1.5rem;
            margin-bottom: 20px;
            color: var(--text-primary);
            border-bottom: 2px solid var(--primary);
            padding-bottom: 10px;
        }

        h3 {
            font-size: 1.2rem;
            margin: 20px 0 10px 0;
            color: var(--text-primary);
        }

        .theme-toggle {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            color: var(--text-primary);
            transition: all 0.3s;
        }

        .theme-toggle:hover {
            background: var(--primary);
            color: white;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid var(--border-color);
        }

        .tab {
            padding: 12px 24px;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 1rem;
            color: var(--text-secondary);
            transition: all 0.3s;
        }

        .tab:hover {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
            font-weight: 600;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary);
        }

        .chart-container {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .chart-wrapper {
            position: relative;
            height: 350px;
        }

        .endpoint-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .endpoint-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .method-badge {
            padding: 4px 12px;
            border-radius: 6px;
            font-weight: bold;
            font-size: 0.85rem;
        }

        .method-get {
            background: #28a745;
            color: white;
        }

        .method-post {
            background: #007bff;
            color: white;
        }

        .endpoint-path {
            font-family: 'Courier New', monospace;
            font-size: 1.1rem;
            color: var(--text-primary);
            font-weight: 600;
        }

        .endpoint-description {
            color: var(--text-secondary);
            margin-bottom: 15px;
        }

        code {
            background: var(--code-bg);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
        }

        pre {
            background: var(--code-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            overflow-x: auto;
            margin: 10px 0;
        }

        pre code {
            background: none;
            padding: 0;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-primary);
        }

        input, select, textarea {
            width: 100%;
            padding: 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            color: var(--text-primary);
            font-family: inherit;
        }

        textarea {
            font-family: 'Courier New', monospace;
            resize: vertical;
            min-height: 150px;
        }

        button {
            padding: 12px 24px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }

        button:hover {
            background: #0056b3;
            transform: translateY(-2px);
        }

        button:disabled {
            background: var(--text-secondary);
            cursor: not-allowed;
            transform: none;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .response-time {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-top: 10px;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .sample-data-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .sample-btn {
            padding: 8px 16px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .sample-btn:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .refresh-btn {
            background: var(--success);
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
        }

        .refresh-btn:hover {
            background: #218838;
        }

        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }

            h1 {
                font-size: 1.5rem;
            }

            header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
        }
    </style>
</head>
<body data-theme="light">
    <header>
        <div>
            <h1>ğŸ¥ StudyMate API Dashboard</h1>
            <p style="color: var(--text-secondary); margin-top: 5px;">Monitoring & Testing Interface</p>
        </div>
        <button class="theme-toggle" onclick="toggleTheme()">
            <span id="theme-icon">ğŸŒ™</span> Changer le thÃ¨me
        </button>
    </header>

    <div class="container">
        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" onclick="showTab('stats')">ğŸ“Š Statistiques</button>
            <button class="tab" onclick="showTab('docs')">ğŸ“– Documentation</button>
            <button class="tab" onclick="showTab('test')">ğŸ§ª Testeur API</button>
        </div>

        <!-- Stats Tab -->
        <div id="stats-tab" class="tab-content active">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>ğŸ“Š Statistiques en temps rÃ©el</h2>
                <button class="refresh-btn" onclick="loadStats()">ğŸ”„ Actualiser</button>
            </div>

            <div class="stats-grid" id="stats-cards">
                <div class="stat-card">
                    <div class="stat-label">Chargement...</div>
                    <div class="stat-value">â³</div>
                </div>
            </div>

            <div class="chart-container">
                <h3>ğŸ“ˆ Ã‰volution des requÃªtes (7 derniers jours)</h3>
                <div class="chart-wrapper">
                    <canvas id="requestsChart"></canvas>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px;">
                <div class="chart-container">
                    <h3>ğŸ¯ RÃ©partition par endpoint</h3>
                    <div class="chart-wrapper" style="height: 300px;">
                        <canvas id="endpointChart"></canvas>
                    </div>
                </div>

                <div class="chart-container">
                    <h3>ğŸ“Š Distribution des difficultÃ©s</h3>
                    <div class="chart-wrapper" style="height: 300px;">
                        <canvas id="difficultyChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="chart-container">
                <h3>â±ï¸ Temps de rÃ©ponse moyen par jour</h3>
                <div class="chart-wrapper">
                    <canvas id="responseTimeChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Documentation Tab -->
        <div id="docs-tab" class="tab-content">
            <h2>ğŸ“– Documentation de l'API</h2>
            <p style="color: var(--text-secondary); margin-bottom: 30px;">
                L'API StudyMate permet de gÃ©nÃ©rer automatiquement des questions et fiches de rÃ©vision Ã  partir de documents pÃ©dagogiques.
            </p>

            <!-- GET / -->
            <div class="endpoint-card">
                <div class="endpoint-header">
                    <span class="method-badge method-get">GET</span>
                    <span class="endpoint-path">/</span>
                </div>
                <div class="endpoint-description">
                    VÃ©rifier le statut de l'API et obtenir des informations sur les endpoints disponibles.
                </div>
                <h4>RÃ©ponse (200 OK)</h4>
                <pre><code>{
  "status": "ok",
  "message": "Backend StudyMate API v3 - Mistral AI avec support BYOK",
  "version": "3.0.0",
  "provider": "Mistral AI",
  "model": "open-mixtral-8x7b",
  "byok": true,
  "serverKeyConfigured": false,
  "endpoints": {
    "POST /generate-questions": "Format simple (legacy)",
    "POST /generate-complete-theme": "Format complet avec fiches (recommandÃ©)"
  },
  "timestamp": "2025-11-06T14:30:45+01:00"
}</code></pre>
                <h4>Exemple cURL</h4>
                <pre><code>curl https://ergo-mate.mehdydriouech.fr/api.php</code></pre>
            </div>

            <!-- POST /generate-complete-theme -->
            <div class="endpoint-card">
                <div class="endpoint-header">
                    <span class="method-badge method-post">POST</span>
                    <span class="endpoint-path">/generate-complete-theme</span>
                </div>
                <div class="endpoint-description">
                    âœ… <strong>RECOMMANDÃ‰</strong> - GÃ©nÃ¨re un thÃ¨me complet avec questions ET fiches de rÃ©vision structurÃ©es.
                </div>
                
                <h4>ParamÃ¨tres (JSON body)</h4>
                <pre><code>{
  "text": "Contenu du document Ã  analyser...",
  "config": {
    "questionCount": 10,           // Nombre de questions (1-50)
    "difficulty": "moyen",          // "facile", "moyen", "difficile"
    "types": ["mcq", "true_false"]  // Types: mcq, true_false, fill_in
  },
  "apiKey": "sk-...",              // Optionnel si clÃ© serveur configurÃ©e
  "model": "open-mixtral-8x7b",    // Optionnel, modÃ¨le Mistral Ã  utiliser
  "metadata": {                     // Optionnel
    "fileName": "document.pdf",
    "author": "Nom de l'auteur"
  }
}</code></pre>

                <h4>RÃ©ponse (200 OK)</h4>
                <pre><code>{
  "title": "Titre du thÃ¨me",
  "description": "Description...",
  "tags": ["tag1", "tag2"],
  "questions": [
    {
      "id": "q001",
      "type": "mcq",
      "prompt": "Question ?",
      "choices": [
        {"id": "a", "label": "Option A"},
        {"id": "b", "label": "Option B"},
        {"id": "c", "label": "Option C"},
        {"id": "d", "label": "Option D"}
      ],
      "answer": "a",
      "rationale": "Explication dÃ©taillÃ©e",
      "tags": ["concept"]
    }
  ],
  "revisionCards": [
    {
      "sectionTitle": "Section 1",
      "cards": [...]
    }
  ]
}</code></pre>

                <h4>Exemple cURL</h4>
                <pre><code>curl -X POST https://ergo-mate.mehdydriouech.fr/api.php/generate-complete-theme \
  -H "Content-Type: application/json" \
  -d '{
    "text": "L'\''ergothÃ©rapie est une profession de santÃ©...",
    "config": {
      "questionCount": 10,
      "difficulty": "moyen",
      "types": ["mcq", "true_false"]
    },
    "apiKey": "votre-cle-api-mistral"
  }'</code></pre>
            </div>

            <!-- POST /generate-questions -->
            <div class="endpoint-card">
                <div class="endpoint-header">
                    <span class="method-badge method-post">POST</span>
                    <span class="endpoint-path">/generate-questions</span>
                </div>
                <div class="endpoint-description">
                    âš ï¸ <strong>LEGACY</strong> - Format simple gÃ©nÃ©rant uniquement des questions (sans fiches de rÃ©vision).
                </div>
                
                <h4>ParamÃ¨tres (JSON body)</h4>
                <pre><code>{
  "text": "Contenu du document...",
  "config": {
    "questionCount": 10,
    "difficulty": "moyen",
    "types": ["mcq", "true_false"]
  },
  "apiKey": "sk-..."  // Optionnel
}</code></pre>

                <h4>RÃ©ponse (200 OK)</h4>
                <pre><code>{
  "title": "Titre",
  "description": "Description",
  "tags": ["tag1"],
  "questions": [...]
}</code></pre>

                <h4>Exemple cURL</h4>
                <pre><code>curl -X POST https://ergo-mate.mehdydriouech.fr/api.php/generate-questions \
  -H "Content-Type: application/json" \
  -d '{
    "text": "Votre contenu...",
    "config": {"questionCount": 5, "difficulty": "facile", "types": ["mcq"]}
  }'</code></pre>
            </div>

            <!-- Codes d'erreur -->
            <div class="endpoint-card">
                <h3>âŒ Codes d'erreur</h3>
                <table style="width: 100%; border-collapse: collapse; margin-top: 15px;">
                    <thead>
                        <tr style="background: var(--bg-secondary);">
                            <th style="padding: 10px; text-align: left; border: 1px solid var(--border-color);">Code</th>
                            <th style="padding: 10px; text-align: left; border: 1px solid var(--border-color);">Description</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td style="padding: 10px; border: 1px solid var(--border-color);"><code>400</code></td>
                            <td style="padding: 10px; border: 1px solid var(--border-color);">DonnÃ©es JSON invalides ou paramÃ¨tres manquants</td>
                        </tr>
                        <tr style="background: var(--bg-secondary);">
                            <td style="padding: 10px; border: 1px solid var(--border-color);"><code>401</code></td>
                            <td style="padding: 10px; border: 1px solid var(--border-color);">ClÃ© API manquante ou invalide</td>
                        </tr>
                        <tr>
                            <td style="padding: 10px; border: 1px solid var(--border-color);"><code>500</code></td>
                            <td style="padding: 10px; border: 1px solid var(--border-color);">Erreur serveur ou erreur API Mistral</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Test Tab -->
        <div id="test-tab" class="tab-content">
            <h2>ğŸ§ª Testeur d'API</h2>
            <p style="color: var(--text-secondary); margin-bottom: 30px;">
                Testez l'API avec des donnÃ©es prÃ©-remplies ou personnalisÃ©es.
            </p>

            <div class="form-group">
                <label>ğŸ“ DonnÃ©es de test :</label>
                <div class="sample-data-selector">
                    <button class="sample-btn" onclick="loadSampleData('ergo')">ğŸ“š ErgothÃ©rapie</button>
                    <button class="sample-btn" onclick="loadSampleData('generic')">ğŸ“„ Texte gÃ©nÃ©rique</button>
                </div>
            </div>

            <div class="form-group">
                <label for="endpoint">ğŸ¯ Endpoint :</label>
                <select id="endpoint">
                    <option value="/generate-complete-theme">POST /generate-complete-theme (RecommandÃ©)</option>
                    <option value="/generate-questions">POST /generate-questions (Legacy)</option>
                </select>
            </div>

            <div class="form-group">
                <label for="apiKey">ğŸ”‘ ClÃ© API Mistral (optionnel si clÃ© serveur configurÃ©e) :</label>
                <input type="password" id="apiKey" placeholder="sk-...">
                <small style="color: var(--text-secondary);">Laissez vide pour utiliser la clÃ© serveur si configurÃ©e</small>
            </div>

            <div class="form-group">
                <label for="testText">ğŸ“„ Texte Ã  analyser :</label>
                <textarea id="testText" placeholder="Collez votre texte ici..."></textarea>
            </div>

            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px;">
                <div class="form-group">
                    <label for="questionCount">ğŸ“Š Nombre de questions :</label>
                    <input type="number" id="questionCount" value="5" min="1" max="50">
                </div>

                <div class="form-group">
                    <label for="difficulty">ğŸšï¸ DifficultÃ© :</label>
                    <select id="difficulty">
                        <option value="facile">Facile</option>
                        <option value="moyen" selected>Moyen</option>
                        <option value="difficile">Difficile</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="model">ğŸ¤– ModÃ¨le Mistral :</label>
                    <select id="model">
                        <option value="open-mixtral-8x7b" selected>open-mixtral-8x7b (Gratuit)</option>
                        <option value="open-mistral-7b">open-mistral-7b (Gratuit)</option>
                        <option value="mistral-small-latest">mistral-small-latest (Payant)</option>
                        <option value="mistral-large-latest">mistral-large-latest (Payant)</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label>ğŸ“‘ Types de questions :</label>
                <div style="display: flex; gap: 20px; margin-top: 10px;">
                    <label style="display: flex; align-items: center; gap: 8px;">
                        <input type="checkbox" id="type-mcq" checked>
                        <span>QCM</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px;">
                        <input type="checkbox" id="type-true-false" checked>
                        <span>Vrai/Faux</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px;">
                        <input type="checkbox" id="type-fill-in">
                        <span>Ã€ complÃ©ter</span>
                    </label>
                </div>
            </div>

            <button onclick="testAPI()" id="test-btn">ğŸš€ Tester l'API</button>

            <div id="test-result"></div>
        </div>
    </div>

    <script>
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // THEME MANAGEMENT
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        function toggleTheme() {
            const body = document.body;
            const icon = document.getElementById('theme-icon');
            const currentTheme = body.getAttribute('data-theme');
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            
            body.setAttribute('data-theme', newTheme);
            icon.textContent = newTheme === 'light' ? 'ğŸŒ™' : 'â˜€ï¸';
            localStorage.setItem('theme', newTheme);
            
            // Recharger les graphiques avec le nouveau thÃ¨me
            if (document.getElementById('stats-tab').classList.contains('active')) {
                loadStats();
            }
        }

        // Charger le thÃ¨me depuis localStorage au dÃ©marrage
        window.addEventListener('DOMContentLoaded', () => {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.body.setAttribute('data-theme', savedTheme);
            document.getElementById('theme-icon').textContent = savedTheme === 'light' ? 'ğŸŒ™' : 'â˜€ï¸';
        });

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // TAB MANAGEMENT
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        function showTab(tabName) {
            // Masquer tous les contenus
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // DÃ©sactiver tous les onglets
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Activer l'onglet sÃ©lectionnÃ©
            document.getElementById(tabName + '-tab').classList.add('active');
            event.target.classList.add('active');
            
            // Charger les stats si on affiche l'onglet stats
            if (tabName === 'stats') {
                loadStats();
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // STATS LOADING
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        let charts = {};

        function loadStats() {
            const cardsContainer = document.getElementById('stats-cards');
            cardsContainer.innerHTML = '<div class="stat-card"><div class="stat-label">Chargement...</div><div class="stat-value">â³</div></div>';

            fetch('api-stats.php', {
                headers: {
                    'Authorization': 'Basic ' + btoa('admin:admin')
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Erreur d\'authentification');
                }
                return response.json();
            })
            .then(data => {
                displayStatsCards(data);
                displayCharts(data);
            })
            .catch(error => {
                cardsContainer.innerHTML = `<div class="stat-card"><div class="stat-label">Erreur</div><div class="stat-value">âŒ</div></div>`;
                console.error('Erreur:', error);
            });
        }

        function displayStatsCards(data) {
            const cardsContainer = document.getElementById('stats-cards');
            
            const cards = [
                { label: 'ğŸ“Š Total requÃªtes', value: data.totalRequests.toLocaleString() },
                { label: 'âœ… Taux de succÃ¨s', value: data.successRate + '%' },
                { label: 'â±ï¸ Temps moyen', value: data.avgExecutionTime + 's' },
                { label: 'ğŸ¤– Temps API Mistral', value: data.avgMistralApiTime + 's' },
                { label: 'ğŸ”‘ ClÃ© custom utilisÃ©e', value: data.customApiKeyUsage.percentage + '%' },
                { label: 'ğŸ’¬ Tokens totaux', value: data.tokens.total.toLocaleString() }
            ];
            
            cardsContainer.innerHTML = cards.map(card => `
                <div class="stat-card">
                    <div class="stat-label">${card.label}</div>
                    <div class="stat-value">${card.value}</div>
                </div>
            `).join('');
        }

        function displayCharts(data) {
            const isDark = document.body.getAttribute('data-theme') === 'dark';
            const textColor = isDark ? '#e9ecef' : '#212529';
            const gridColor = isDark ? '#495057' : '#dee2e6';
            
            Chart.defaults.color = textColor;
            Chart.defaults.borderColor = gridColor;

            // DÃ©truire les graphiques existants
            Object.values(charts).forEach(chart => chart.destroy());
            charts = {};

            // Graphique : Ã‰volution des requÃªtes
            const byDay = data.stats.byDay;
            const dates = Object.keys(byDay).slice(-7);
            const counts = dates.map(date => byDay[date]);
            
            charts.requests = new Chart(document.getElementById('requestsChart'), {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [{
                        label: 'RequÃªtes',
                        data: counts,
                        borderColor: '#007bff',
                        backgroundColor: 'rgba(0, 123, 255, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });

            // Graphique : Par endpoint
            const byEndpoint = data.stats.byEndpoint;
            charts.endpoint = new Chart(document.getElementById('endpointChart'), {
                type: 'doughnut',
                data: {
                    labels: Object.keys(byEndpoint),
                    datasets: [{
                        data: Object.values(byEndpoint),
                        backgroundColor: ['#007bff', '#28a745', '#ffc107', '#dc3545']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });

            // Graphique : Par difficultÃ©
            const byDifficulty = data.stats.byDifficulty;
            charts.difficulty = new Chart(document.getElementById('difficultyChart'), {
                type: 'pie',
                data: {
                    labels: Object.keys(byDifficulty),
                    datasets: [{
                        data: Object.values(byDifficulty),
                        backgroundColor: ['#28a745', '#ffc107', '#dc3545']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });

            // Graphique : Temps de rÃ©ponse
            charts.responseTime = new Chart(document.getElementById('responseTimeChart'), {
                type: 'bar',
                data: {
                    labels: dates,
                    datasets: [{
                        label: 'Temps moyen (s)',
                        data: dates.map(() => data.avgExecutionTime),
                        backgroundColor: '#17a2b8'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // API TESTING
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        const sampleData = {
            ergo: `L'ergothÃ©rapie est une profession de santÃ© qui vise Ã  maintenir, restaurer et permettre les activitÃ©s humaines de maniÃ¨re sÃ©curisÃ©e, autonome et efficace. Elle intervient auprÃ¨s de personnes de tout Ã¢ge prÃ©sentant des difficultÃ©s motrices, sensorielles, cognitives ou psychiques.

L'ergothÃ©rapeute Ã©value les capacitÃ©s de la personne Ã  effectuer ses activitÃ©s quotidiennes (se laver, s'habiller, se dÃ©placer, travailler, etc.) et propose des solutions adaptÃ©es : amÃ©nagement de l'environnement, prÃ©conisation d'aides techniques, rÃ©Ã©ducation fonctionnelle.

La formation d'ergothÃ©rapeute dure 3 ans en Institut de Formation en ErgothÃ©rapie (IFE) et aboutit Ã  un DiplÃ´me d'Ã‰tat.`,
            
            generic: `Le cafÃ© est l'une des boissons les plus consommÃ©es au monde. Il est prÃ©parÃ© Ã  partir des graines torrÃ©fiÃ©es du cafÃ©ier, un arbuste tropical.

La cafÃ©ine, principal alcaloÃ¯de du cafÃ©, est un stimulant du systÃ¨me nerveux central. Elle amÃ©liore temporairement la vigilance et rÃ©duit la sensation de fatigue.

Il existe deux principales espÃ¨ces de cafÃ©iers : l'Arabica (plus doux et aromatique) et le Robusta (plus corsÃ© et riche en cafÃ©ine). L'Arabica reprÃ©sente environ 60% de la production mondiale.`
        };

        function loadSampleData(type) {
            document.getElementById('testText').value = sampleData[type];
        }

        async function testAPI() {
            const btn = document.getElementById('test-btn');
            const resultDiv = document.getElementById('test-result');
            
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span> Test en cours...';
            resultDiv.innerHTML = '';

            const endpoint = document.getElementById('endpoint').value;
            const apiKey = document.getElementById('apiKey').value;
            const text = document.getElementById('testText').value;
            const questionCount = parseInt(document.getElementById('questionCount').value);
            const difficulty = document.getElementById('difficulty').value;
            const model = document.getElementById('model').value;
            
            const types = [];
            if (document.getElementById('type-mcq').checked) types.push('mcq');
            if (document.getElementById('type-true-false').checked) types.push('true_false');
            if (document.getElementById('type-fill-in').checked) types.push('fill_in');

            if (!text) {
                resultDiv.innerHTML = '<div class="alert alert-error">âŒ Veuillez fournir un texte Ã  analyser</div>';
                btn.disabled = false;
                btn.innerHTML = 'ğŸš€ Tester l\'API';
                return;
            }

            if (types.length === 0) {
                resultDiv.innerHTML = '<div class="alert alert-error">âŒ Veuillez sÃ©lectionner au moins un type de question</div>';
                btn.disabled = false;
                btn.innerHTML = 'ğŸš€ Tester l\'API';
                return;
            }

            const payload = {
                text: text,
                config: {
                    questionCount: questionCount,
                    difficulty: difficulty,
                    types: types
                },
                model: model
            };

            if (apiKey) {
                payload.apiKey = apiKey;
            }

            const startTime = performance.now();

            try {
                const response = await fetch(`https://ergo-mate.mehdydriouech.fr/api.php${endpoint}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                const endTime = performance.now();
                const responseTime = ((endTime - startTime) / 1000).toFixed(2);

                const data = await response.json();

                if (response.ok) {
                    resultDiv.innerHTML = `
                        <div class="alert alert-success">
                            âœ… SuccÃ¨s ! L'API a rÃ©pondu correctement.
                            <div class="response-time">â±ï¸ Temps de rÃ©ponse : ${responseTime}s</div>
                        </div>
                        <h3>ğŸ“Š RÃ©sultat :</h3>
                        <pre><code>${JSON.stringify(data, null, 2)}</code></pre>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="alert alert-error">
                            âŒ Erreur ${response.status}
                            <div class="response-time">â±ï¸ Temps de rÃ©ponse : ${responseTime}s</div>
                        </div>
                        <h3>ğŸ“Š DÃ©tails de l'erreur :</h3>
                        <pre><code>${JSON.stringify(data, null, 2)}</code></pre>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="alert alert-error">
                        âŒ Erreur de connexion : ${error.message}
                    </div>
                `;
            }

            btn.disabled = false;
            btn.innerHTML = 'ğŸš€ Tester l\'API';
        }

        // Charger les stats au dÃ©marrage
        window.addEventListener('DOMContentLoaded', () => {
            loadStats();
            loadSampleData('ergo'); // Charger les donnÃ©es d'exemple par dÃ©faut
        });
    </script>
</body>
</html>
